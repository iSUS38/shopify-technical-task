{{ 'customer.css' | asset_url | stylesheet_tag }}

{%- capture content -%}
  <div class="order__main">
    <div>
      <a class="button button--text" href="{{ routes.account_url }}">        
        {%- render 'icon' with 'arrow-left', class: 'icon-s'-%}
        <span class="button-text__label">{{ 'customer.orders.back' | t }}</span>
      </a>
    </div>
    <div>
      <h2 class="order__heading h1">{{ 'customer.order.title' | t: name: order.name }}</h2>
      <div class="order__details">
        <div class="order__details-block order__details-block--full">
          <h3 class="h6 order__details-heading">{{ 'customer.orders.overview' | t }}</h3>
          <div class="order__details-content secondary">
            {%- assign order_date = order.created_at | time_tag: format: 'date_at_time' -%}
            <p>{{ 'customer.order.date_html' | t: date: order_date }}</p>
            <p>
              {{ 'customer.order.payment_status' | t }}:
              {{ order.financial_status_label }}
            </p>
            <p>
              {{ 'customer.order.fulfillment_status' | t }}:
              {{ order.fulfillment_status_label }}
            </p>
            {%- if order.cancelled -%}
              {%- assign cancelled_at = order.cancelled_at | time_tag: format: 'date_at_time' -%}
              <p>{{ 'customer.order.cancelled_html' | t: date: cancelled_at }}</p>
              <p>{{ 'customer.order.cancelled_reason' | t: reason: order.cancel_reason_label }}</p>
            {%- endif -%}
          </div>
        </div>

        <div class="order__details__block">
          <h3 class="h6 order__details-heading">{{ 'customer.order.billing_address' | t }}</h3>
          <div class="order__details-content secondary">
            {{ order.billing_address | format_address }}
          </div>
        </div>
        <div class="order__details__block">
          <h3 class="h6 order__details-heading">{{ 'customer.order.shipping_address' | t }}</h3>
          <div class="order__details-content secondary">
            {{ order.shipping_address | format_address }}
          </div>
        </div>
      </div>
    </div>

    <table class="cart__table order__table">
      <caption class="visually-hidden">
        {{- 'customer.order.order_items' | t -}}
      </caption>
      <thead class="text-s caption secondary order__table-header">
        <tr>
          <th class="cart__heading heading--product left" scope="col">
            {{- 'cart.headings.product' | t -}}
          </th>
          <th class="cart__heading cart__heading--quantity left order__quantity" scope="col">
            {{- 'cart.headings.quantity' | t -}}
          </th>
          <th class="cart__heading cart__heading--totals right hidden lg:table-cell" scope="col">
            {{- 'cart.headings.total' | t -}}
          </th>
        </tr>
      </thead>
      <tbody>
        {%- for item in order.line_items -%}
          <tr class="cart-item order__item">

            <td class="cart-item__product">
              <div class="flex order__product-wrapper expand-link">
                {%- liquid 
                  if settings.card_image_ratio == 'default'
                    assign image_ratio = item.image.aspect_ratio | default: 1
                  else
                    assign image_ratio = settings.card_image_ratio
                  endif
                -%}
                {%- if item.image -%}
                  <div class="cart-item__product-image">
                    {%- assign widths = '100, 150, 200, 250, 300, 400, 600, 800, 1200' -%}
                    <div class="cart-item__image-wrapper image-ratio" style="--image-ratio: {{ image_ratio }};--image-max-width: var(--space-2xl);">
                      {{ item.image | image_url: width: 2200 | image_tag: class: '', sizes: '12.5rem', widths: widths }}
                    </div>
                  </div>
                {%- else -%}
                  <div class="cart-item__image-wrapper media-wrapper--placeholder image-ratio" style="--image-ratio: {{ image_ratio }};--image-max-width: var(--space-2xl);"></div>
                {%- endif -%}
                <div class="order__item-detail">
                  <a href="{{ item.url }}" class="cart-item__title expand-link__link link-hover-underline h6">{{ item.product.title }}</a>

                  {%- if item.product.metafields.descriptors.subtitle != blank -%}
                    <p class="cart-item__subtitle caption secondary">{{ item.product.metafields.descriptors.subtitle }}</p>
                  {%- endif -%}

                  <div class="cart-item__price-wrapper list-separator list-separator--text text-s">
                    {%- if item.original_price != item.final_price -%}
                      <div class="cart-item__price list-separator__item">
                        <span class="visually-hidden">
                          {{ 'products.product.price.sale_price' | t }}
                        </span>
                        <span class="exception">
                          {{- item.final_price | money -}}
                        </span>
                        <span class="visually-hidden">
                          {{ 'products.product.price.regular_price' | t }}
                        </span>
                        <s class="secondary">
                          {{- item.original_price | money -}}
                        </s>
                      </div>
                    {%- else -%}
                      <div class="cart-item__price caption list-separator__item">
                        {%- if item.original_price == 0 and settings.card_show_price_free == true -%}
                          {{ 'products.product.price.free' | t }}
                        {%- else -%}
                          {{ item.original_price | money }}
                        {%- endif -%}
                      </div>
                    {%- endif -%}

                    {%- if item.unit_price_measurement -%}
                      <small class="unit-price text-xs list-separator__item">
                        <span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
                        <span class="secondary">
                          <span>{{- item.unit_price | money -}}</span>
                          <span aria-hidden="true">/</span>
                          <span class="visually-hidden">&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span>
                          <span>
                            {%- if item.unit_price_measurement.reference_value != 1 -%}
                              {{- item.unit_price_measurement.reference_value -}}
                            {%- endif -%}
                            {{- item.unit_price_measurement.reference_unit -}}
                          </span>
                        </span>
                      </small>
                    {%- endif -%}
                  </div>

                  {%- if settings.cart_show_vendor -%}
                    <p class="caption-xs">{{ item.product.vendor }}</p>
                  {%- endif -%}

                  {%- assign property_size = item.properties | size -%}

                  {%- if item.product.has_only_default_variant == false
                    or property_size != 0
                    or item.selling_plan_allocation != null
                  -%}
                    <dl class="cart-item__options">
                      {%- if item.product.has_only_default_variant == false -%}
                        {%- for option in item.options_with_values -%}
                          <div class="cart-item__option caption-xs">
                            <dt>{{ option.name }}:</dt>
                            <dd>{{ option.value }}</dd>
                          </div>
                        {%- endfor -%}
                      {%- endif -%}

                      {%- for property in item.properties -%}
                        {%- assign property_first_char = property.first | slice: 0 -%}
                        {%- if property.last != blank and property_first_char != '_' -%}
                          <div class="cart-item__option caption-xs">
                            <dt class="caption">{{ property.first }}:</dt>
                            <dd>
                              {%- if property.last contains '/uploads/' -%}
                                <a href="{{ property.last }}" class="link" target="_blank">
                                  {{ property.last | split: '/' | last }}
                                </a>
                              {%- else -%}
                                {{ property.last }}
                              {%- endif -%}
                            </dd>
                          </div>
                        {%- endif -%}
                      {%- endfor -%}
                    </dl>

                    {%- if item.selling_plan_allocation != null -%}
                      <p class="cart-item__option caption-xs">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                    {%- endif -%}
                  {%- endif -%}

                  {%- if item.line_level_discount_allocations.size > 0 -%}
                    <ul class="exception list-unstyled" role="list" aria-label="{{ 'customer.order.discount' | t }}">
                      {%- for discount in item.line_level_discount_allocations -%}
                        <li class="discounts__discount text-s">
                          {{- discount.discount_application.title | escape -}}
                        </li>
                      {%- endfor -%}
                    </ul>
                  {%- endif -%}

                  {%- if item.fulfillment -%}
                    <div class="order__fulfillment text-xs caption">
                      {%- assign created_at = item.fulfillment.created_at | time_tag: format: 'date' -%}
                      <span class="secondary">{{ 'customer.order.fulfilled_at_html' | t: date: created_at }}</span>
                      <span>
                        {{ item.fulfillment.tracking_company }}
                        {%- if item.fulfillment.tracking_number -%}
                          #{{ item.fulfillment.tracking_number }}
                        {%- endif -%}
                      </span>
                      {%- if item.fulfillment.tracking_url -%}
                        <a href="{{ item.fulfillment.tracking_url }}">
                          {{ 'customer.order.track_shipment' | t }}
                        </a>
                      {%- endif -%}
                    </div>
                  {%- endif -%}
                </div>
              </div>
            </td>

            <td class="order__quantity center">
              {{ item.quantity }}
            </td>

            <td class="order__total-wrapper">
              {% assign count = item.quantity %}
              <span class="order__total-text caption">{{ 'customer.order.total_count' | t: count: count }}:</span>
              <div class="cart-item__price-wrapper">
                {%- if item.original_line_price != item.final_line_price -%}
                  <dl class="cart-item__price caption">
                    <dt class="visually-hidden">
                      {{ 'products.product.price.sale_price' | t }}
                    </dt>
                    <dd class="exception">
                      {{- item.final_line_price | money -}}
                    </dd>
                    <dt class="visually-hidden">
                      {{ 'products.product.price.regular_price' | t }}
                    </dt>
                    <dd>
                      <s class="secondary">
                        {{- item.original_line_price | money -}}
                      </s>
                    </dd>
                  </dl>
                {%- else -%}
                  <div class="cart-item__price caption">
                    {%- if item.original_line_price == 0 and settings.card_show_price_free == true -%}
                      {{ 'products.product.price.free' | t }}
                    {%- else -%}
                      {{- item.original_line_price | money -}}
                    {%- endif -%}
                  </div>
                {%- endif -%}
              </div>
            </td>
          </tr>
        {%- endfor -%}
      </tbody>
    </table>
    <dl class="order__footer">
      <dt class="caption">
        {{ 'customer.order.subtotal' | t }}
      </dt>
      <dd class="caption">
        {{ order.line_items_subtotal_price | money }}
      </dd>
      {%- if order.cart_level_discount_applications != blank -%}
        {%- for discount_application in order.cart_level_discount_applications -%}
          <dt class="caption">
            <span class="cart-discount exception">
              {{- discount_application.title | escape -}}
            </span>
          </dt>
          <dd class="caption">
            <span class="exception">-{{ discount_application.total_allocated_amount | money }}</span>
          </dd>
        {%- endfor -%}
      {%- endif -%}
      {%- for shipping_method in order.shipping_methods -%}
        <dt class="caption">
          {{ 'customer.order.shipping' | t }} ({{ shipping_method.title | escape }})
        </dt>
        <dd class="caption">
          {{ shipping_method.price | money }}
        </dd>
      {%- endfor -%}
      {%- for tax_line in order.tax_lines -%}
        <dt class="caption">
          {{ 'customer.order.tax' | t }} ({{ tax_line.title | escape }}
          {{ tax_line.rate | times: 100 }}%)
        </dt>
        <dd class="caption">
          {{ tax_line.price | money }}
        </dd>
      {%- endfor -%}
      {%- if order.total_duties -%}
        <dt class="caption">{{ 'customer.order.total_duties' | t }}</dt>
        <dd class="caption">
          {{ order.total_duties | money }}
        </dd>
      {%- endif -%}
      {%- if order.total_refunded_amount > 0 -%}
        <dt class="caption">
          {{ 'customer.order.total_refunded' | t }}
        </dt>
        <dd class="caption">
          -{{ order.total_refunded_amount | money_with_currency }}
        </dd>
      {%- endif -%}
      <dt class="caption order__footer-total">{{ 'cart.headings.total' | t }}</dt>
      <dd class="order__footer-total caption">
        {{ order.total_net_amount | money_with_currency }}
      </dd>
    </dl>
  </div>
{%- endcapture -%}

{% render 'account-layout', content: content %}
