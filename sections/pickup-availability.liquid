{% comment %}theme-check-disable UndefinedObject{% endcomment %}
{%- assign pick_up_availabilities = product_variant.store_availabilities | where: 'pick_up_enabled', true -%}
{%- if pick_up_availabilities.size > 0 -%}
  <pickup-availability-preview class="pickup-availability__preview">
    {% assign closest_location = pick_up_availabilities.first %}
    {% if closest_location.available %}
      {%- render 'icon' with 'check', class: 'icon--m' -%}
    {% endif %}
    <div class="pickup-availability__preview-content">
      {%- if closest_location.available -%}
        <p class="caption">{{ 'products.product.pickup_availability.pick_up_available_at_html' | t: location_name: closest_location.location.name }}</p>
        <p class="secondary text-xs">{{ closest_location.pick_up_time }}</p>
        <button class="button button--text" aria-haspopup="dialog">
          <span class="button-text__label">
            {%- if pick_up_availabilities.size == 1 -%}
              {{ 'products.product.pickup_availability.view_store_info' | t }}
            {%- else -%}
              {{ 'products.product.pickup_availability.check_other_stores' | t }}
            {%- endif -%}
          </span>
        </button>
      {%- else -%}
        <p class="caption">{{ 'products.product.pickup_availability.pick_up_unavailable_at_html' | t: location_name: closest_location.location.name }}</p>
        {%- if pick_up_availabilities.size > 1 -%}
          <button class="button button--text" aria-haspopup="dialog">
            <span class="button-text__label">
              {{ 'products.product.pickup_availability.check_other_stores' | t }}
            </span>
          </button>
        {%- endif -%}
      {%- endif -%}
    </div>
  </pickup-availability-preview>

  <custom-dialog data-modal="true" data-overlay="true" data-name="pickup-availability" data-display="flex">
    <dialog class="dialog" aria-labelledby="pickup-availability-title-{{ section.id }}-{{ product.id }}">
      <div class="dialog__window dialog__animateable dialog__window--drawer" data-color-scheme="{{ settings.overlay_color_scheme }}">
        <div class="dialog__header dialog__header--top">
          <div class="pickup-availability__dialog-heading">
            <h2 id="pickup-availability-title-{{ section.id }}-{{ product.id }}" class="h4">{{ product_variant.product.title | escape }}</h2>
            {%- unless product_variant.product.has_only_default_variant -%}
              <div class="pickup-availability__variants">
                {%- for product_option in product_variant.product.options_with_values -%}
                  {%- for value in product_option.values -%}
                    {%- if product_option.selected_value == value -%}
                      <span class="text-s secondary">{{ value | escape }}</span>
                    {%- endif -%}
                  {%- endfor -%}
                  {%- unless forloop.last -%}/&nbsp;{%- endunless -%}
                {%- endfor -%}
              </div>
            {%- endunless -%}
          </div>
          {% render 'close-button' %}
        </div>
        <div class="pickup-availability__dialog-body">
          <ul class="pickup-availability__list list-unstyled" role="list" data-store-availability-drawer-content>
            {%- for availability in pick_up_availabilities -%}
              <li class="pickup-availability__list-item">
                <h3 class="h6">{{ availability.location.name | escape }}</h3>
                {%- assign address = availability.location.address -%}
                <address class="pickup-availability__address text-s">
                  {{ address | format_address }}
                  {%- if address.phone.size > 0 -%}
                    {{ address.phone }}
                  {%- endif -%}
                </address>
                <div class="pickup-availability__preview items-center">
                  {%- if availability.available -%}
                    {%- render 'icon' with 'check', class: 'icon--m' -%}
                    <p class="">{{ 'products.product.pickup_availability.pick_up_available' | t }}, {{ availability.pick_up_time | downcase }}</p>
                  {%- endif -%}
                </div>
              </li>
            {%- endfor -%}
          </ul>
        </div>
      </div>
    </dialog>
  </custom-dialog>
{%- endif -%}
